{% extends 'base.html' %}

{% import 'admin/header_bar.html' as admin_header %}

{% block title %}Create Event - Admin{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
<style>
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    .page-header h2 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 600;
    }
    .toggle-buttons {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
    }
    .toggle-btn {
        flex: 1;
        padding: 1rem;
        border: 2px solid #667eea;
        background: white;
        color: #667eea;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .toggle-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }
    .toggle-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .form-card {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(102, 126, 234, 0.1);
    }
    .form-section {
        margin-bottom: 2rem;
    }
    .form-section h4 {
        color: #667eea;
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid rgba(102, 126, 234, 0.1);
    }
    .form-group label {
        color: #667eea;
        font-weight: 500;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .form-control {
        border: 1px solid rgba(102, 126, 234, 0.2);
        border-radius: 8px;
        padding: 0.7rem;
    }
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
    }
    .sub-event {
        background: #f8f9fa;
        border: 2px dashed rgba(102, 126, 234, 0.3);
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
    .sub-event h5 {
        color: #667eea;
        margin-bottom: 1rem;
    }
    .action-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 0.8rem 2rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
        cursor: pointer;
        margin-right: 0.5rem;
    }
    .action-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .action-button.secondary {
        background: white;
        color: #667eea;
        border: 2px solid #667eea;
    }
    .action-button.secondary:hover {
        background: #667eea;
        color: white;
    }
</style>
{% endblock %}

{% block header %}
{{ admin_header.header() }}
{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 1000px; padding-top: 100px;">
    <!-- Page Header -->
    <div class="page-header">
        <h2>{% if event %}‚úèÔ∏è Edit Event{% else %}‚ûï Create New Event{% endif %}</h2>
    </div>

    <!-- Toggle Buttons -->
    {% if not event %}
    <div class="toggle-buttons">
        <button type="button" class="toggle-btn active" id="showSingleEventForm">üìÖ Single Event</button>
        <button type="button" class="toggle-btn" id="showMultipleEventForm">üéØ Multiple Events</button>
    </div>
    {% endif %}

    <!-- Single Event Form -->
    <div class="form-card" id="singleEventForm">
        <form action="{% if event %}{{ url_for('admin.edit_event', event_id=event.Event_ID) }}{% else %}{{ url_for('admin.create_single_event') }}{% endif %}" method="POST">
            <div class="form-section">
                <h4>üìù Event Details</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="eventName">Event Name</label>
                            <input type="text" class="form-control" id="eventName" name="eventName" placeholder="Enter event name" value="{{ event.Name if event else '' }}" required {% if event %}readonly{% endif %}>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="eventType">Event Type</label>
                            <select class="form-control" id="eventType" name="eventType" required>
                                <option value="">Select Event Type</option>
                                {% for event_type in event_types %}
                                    <option value="{{ event_type.Event_Type_ID }}" {% if event and event.Event_Type_ID == event_type.Event_Type_ID %}selected{% endif %}>{{ event_type.Event_Type_Name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="eventDate">Event Date</label>
                            <input type="date" class="form-control" id="eventDate" name="eventDate" value="{{ event.Date.strftime('%Y-%m-%d') if event and event.Date else '' }}" required {% if event and sub_events %}disabled title="Cannot change date when sub-events exist"{% endif %}>
                            {% if event and sub_events %}
                                <small class="text-muted">Date cannot be changed when sub-events exist</small>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="department">Department</label>
                            <select class="form-control" id="department" name="department" required>
                                <option value="">Select Department</option>
                                {% for department in departments %}
                                    <option value="{{ department.Dept_ID }}" {% if event and event.Dept_ID == department.Dept_ID %}selected{% endif %}>{{ department.Name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h4>üë• Management Team</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="EveMan">Event Manager</label>
                            <select class="form-control" id="EveMan" name="EveMan" required>
                                <option value="">Select Event Manager</option>
                                {% for manager in event_managers %}
                                    <option value="{{ manager.User_ID }}" {% if event and event.Event_Manager == manager.User_ID %}selected{% endif %}>{{ manager.Username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="FinMan">Finance Manager</label>
                            <select class="form-control" id="FinMan" name="FinMan" required>
                                <option value="">Select Finance Manager</option>
                                {% for manager in finance_managers %}
                                    <option value="{{ manager.User_ID }}" {% if event and event.Finance_Manager == manager.User_ID %}selected{% endif %}>{{ manager.Username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(102, 126, 234, 0.1);">
                <button type="submit" class="action-button">{% if event %}üíæ Update Event{% else %}‚úÖ Create Single Event{% endif %}</button>
                <a href="{% if event %}{{ url_for('admin.event_details', event_id=event.Event_ID) }}{% else %}{{ url_for('admin.view_events') }}{% endif %}" class="action-button secondary" style="text-decoration: none;">‚úï Cancel</a>
            </div>
        </form>
    </div>

    <!-- Multiple Events Form -->
    <div class="form-card" id="multipleEventForm" style="display: none;">
        <form action="{{ url_for('admin.create_multiple_events') }}" method="POST">
            <div class="form-section">
                <h4>üìù Main Event Details</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="eventNameMulti">Main Event Name</label>
                            <input type="text" class="form-control" id="eventNameMulti" name="eventName" placeholder="Enter main event name" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="eventTypeMulti">Event Type</label>
                            <select class="form-control" id="eventTypeMulti" name="eventType" required>
                                <option value="">Select Event Type</option>
                                {% for event_type in event_types %}
                                    <option value="{{ event_type.Event_Type_ID }}">{{ event_type.Event_Type_Name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="eventDateMulti">Start Date</label>
                            <input type="date" class="form-control" id="eventDateMulti" name="eventDate" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="departmentMulti">Department</label>
                            <select class="form-control" id="departmentMulti" name="department" required>
                                <option value="">Select Department</option>
                                {% for department in departments %}
                                    <option value="{{ department.Dept_ID }}">{{ department.Name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h4>üë• Management Team</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="EveManMulti">Event Manager</label>
                            <select class="form-control" id="EveManMulti" name="EveMan" required>
                                <option value="">Select Event Manager</option>
                                {% for manager in event_managers %}
                                    <option value="{{ manager.User_ID }}">{{ manager.Username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="FinManMulti">Finance Manager</label>
                            <select class="form-control" id="FinManMulti" name="FinMan" required>
                                <option value="">Select Finance Manager</option>
                                {% for manager in finance_managers %}
                                    <option value="{{ manager.User_ID }}">{{ manager.Username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-event section -->
            <div class="form-section">
                <h4>üéØ Sub-Events</h4>
                <div id="subEventContainer"></div>
                <button type="button" class="action-button secondary" id="addSubEvent">‚ûï Add Sub-Event</button>
            </div>

            <button type="submit" class="action-button">‚úÖ Create Multiple Events</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function () {
        // Toggle between forms
        $("#showSingleEventForm").on("click", function () {
            $("#singleEventForm").show();
            $("#multipleEventForm").hide();
            $(this).addClass("active");
            $("#showMultipleEventForm").removeClass("active");
        });
    
        $("#showMultipleEventForm").on("click", function () {
            $("#multipleEventForm").show();
            $("#singleEventForm").hide();
            $(this).addClass("active");
            $("#showSingleEventForm").removeClass("active");
        });
    
        // Add sub-event functionality
        let subEventCount = 0;
        $("#addSubEvent").on("click", function () {
            const subEventHTML = `
            <div class="sub-event" data-index="${subEventCount}">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h5 style="margin: 0;">üéØ Sub-Event ${subEventCount + 1}</h5>
                    <button type="button" class="btn btn-danger btn-sm remove-sub-event" style="background: #dc3545; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer;">
                        üóëÔ∏è Remove
                    </button>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="subEventName${subEventCount}">Sub-Event Name</label>
                            <input type="text" class="form-control" name="subEventName${subEventCount}" placeholder="Enter sub-event name" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="subEventType${subEventCount}">Sub-Event Type</label>
                            <select class="form-control" name="subEventType${subEventCount}" required>
                                <option value="">Select Sub-Event Type</option>
                                {% for event_type in event_types %}
                                    <option value="{{ event_type.Event_Type_ID }}">{{ event_type.Event_Type_Name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="subEventDate${subEventCount}">Sub-Event Date</label>
                            <input type="date" class="form-control" name="subEventDate${subEventCount}" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="subEventTime${subEventCount}">Sub-Event Time</label>
                            <input type="time" class="form-control" name="subEventTime${subEventCount}" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="subEventManager${subEventCount}">Sub-Event Manager</label>
                            <select class="form-control" name="subEventManager${subEventCount}" required>
                                <option value="">Select Sub-Event Manager</option>
                                {% for manager in event_managers %}
                                    <option value="{{ manager.User_ID }}">{{ manager.Username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>`;
            $("#subEventContainer").append(subEventHTML);
            subEventCount++;
        });

        // Remove sub-event functionality
        $(document).on("click", ".remove-sub-event", function () {
            $(this).closest(".sub-event").remove();
            
            // Recalculate subEventCount based on remaining sub-events
            subEventCount = $("#subEventContainer .sub-event").length;
            
            // Renumber remaining sub-events
            $("#subEventContainer .sub-event").each(function(index) {
                $(this).find("h5").text(`üéØ Sub-Event ${index + 1}`);
            });
        });
    
        // Single Event Form Submission
        $("#singleEventForm form").on("submit", function (e) {
            e.preventDefault();
            const formData = $(this).serialize();

            $.post("{{ url_for('admin.create_single_event') }}", formData, function (response) {
                if (response.status === "success") {
                    showToast(response.message, 'success');
                    $("#singleEventForm form")[0].reset();
                    setTimeout(() => {
                        window.location.href = "{{ url_for('admin.view_events') }}";
                    }, 1500);
                } else {
                    showToast(response.message, 'error');
                }
            }).fail(function (xhr) {
                let errorMsg = "An error occurred while submitting the form.";
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = xhr.responseJSON.message;
                }
                showToast(errorMsg, 'error');
            });
        });

        // Multiple Events Form Submission
        $("#multipleEventForm form").on("submit", function (e) {
            e.preventDefault();
            
            // Check if at least one sub-event is added
            if (subEventCount === 0) {
                showToast("Please add at least one sub-event before submitting.", 'warning');
                return;
            }
            
            let formData = $(this).serialize();
            formData += "&subEventCount=" + subEventCount;
            
            console.log("Submitting with subEventCount:", subEventCount);
            console.log("Form data:", formData);

            $.post("{{ url_for('admin.create_multiple_events') }}", formData, function (response) {
                if (response.status === "success") {
                    showToast(response.message, 'success');
                    $("#multipleEventForm form")[0].reset();
                    $("#subEventContainer").empty();
                    subEventCount = 0;
                    setTimeout(() => {
                        window.location.href = "{{ url_for('admin.view_events') }}";
                    }, 1500);
                } else {
                    showToast(response.message, 'error');
                }
            }).fail(function (xhr) {
                let errorMsg = "An error occurred while submitting the form.";
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = xhr.responseJSON.message;
                }
                console.error("Error:", xhr);
                showToast(errorMsg, 'error');
            });
        });
    });
</script>
{% endblock %}
