{% extends 'base.html' %}

{% import 'admin/header_bar.html' as admin_header %}

{% block title %}Create New User - Admin{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
<style>
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    .page-header h2 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 600;
    }
    .form-card {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(102, 126, 234, 0.1);
    }
    .form-section {
        margin-bottom: 2rem;
    }
    .form-section h4 {
        color: #667eea;
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid rgba(102, 126, 234, 0.1);
    }
    .form-group label {
        color: #667eea;
        font-weight: 500;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }
    .form-control {
        border: 1px solid rgba(102, 126, 234, 0.2);
        border-radius: 8px;
        padding: 0.7rem;
    }
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
    }
    .action-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 0.8rem 2rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
        cursor: pointer;
        margin-right: 0.5rem;
    }
    .action-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .action-button.secondary {
        background: white;
        color: #667eea;
        border: 2px solid #667eea;
    }
    .action-button.secondary:hover {
        background: #667eea;
        color: white;
    }
    .error-message {
        color: #dc3545;
        font-size: 0.85rem;
        margin-top: 0.3rem;
        display: block;
    }
</style>
{% endblock %}

{% block header %}
{{ admin_header.header() }}
{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 800px; padding-top: 100px;">
    <!-- Page Header -->
    <div class="page-header">
        <h2>{% if user %}‚úèÔ∏è Edit User{% else %}‚ûï Create New User{% endif %}</h2>
    </div>

    <!-- Form Card -->
    <div class="form-card">
        <form id="userForm" action="{% if user %}{{ url_for('admin.edit_user', user_id=user.User_ID) }}{% else %}{{ url_for('admin.new_user') }}{% endif %}" method="POST" onsubmit="return validateForm()">
            <div class="form-section">
                <h4>üë§ User Information</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="username">Full Name</label>
                            <input type="text" class="form-control" id="username" name="username" placeholder="Enter full name" value="{{ user.Username if user else '' }}" required minlength="3" maxlength="30" pattern="[A-Za-z\s]+" title="Name should contain only letters and spaces">
                            <span class="error-message" id="usernameError"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <input type="email" class="form-control" id="email" name="email" placeholder="user@example.com" value="{{ user.Email if user else '' }}" required>
                            <span class="error-message" id="emailError"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h4>üè¢ Organization Details</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="department">Department</label>
                            <select class="form-control" id="department" name="department" required>
                                <option value="" disabled {% if not user %}selected{% endif %}>Select Department</option>
                                {% for department in departments %}
                                    <option value="{{ department.Dept_ID }}" {% if user and user.Dept_ID == department.Dept_ID %}selected{% endif %}>{{ department.Name }}</option>
                                {% endfor %}
                            </select>
                            <span class="error-message" id="departmentError"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="role">Role</label>
                            <select class="form-control" id="role" name="role" required>
                                <option value="" disabled {% if not user %}selected{% endif %}>Select Role</option>
                                {% for role in roles %}
                                    <option value="{{ role.Role_ID }}" {% if user and user.Role == role.Role_ID %}selected{% endif %}>{{ role.Role_Name }}</option>
                                {% endfor %}
                            </select>
                            <span class="error-message" id="roleError"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(102, 126, 234, 0.1);">
                <button type="submit" class="action-button">{% if user %}üíæ Update User{% else %}‚úÖ Create User{% endif %}</button>
                <a href="{{ url_for('admin.users_table') }}" class="action-button secondary" style="text-decoration: none;">‚úï Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function validateForm() {
        let valid = true;
        const usernameInput = document.getElementById('username');
        const emailInput = document.getElementById('email');

        // Clear all error messages
        document.querySelectorAll('.error-message').forEach(function (el) {
            el.innerText = "";
        });

        // Validate Username (Only letters and spaces allowed)
        if (!/^[A-Za-z\s]+$/.test(usernameInput.value)) {
            document.getElementById('usernameError').innerText = "Name must contain only letters and spaces.";
            valid = false;
        }

        // Validate Email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(emailInput.value)) {
            document.getElementById('emailError').innerText = "Please enter a valid email address.";
            valid = false;
        }

        return valid;
    }
</script>
{% endblock %}
