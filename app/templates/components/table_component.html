<link rel="stylesheet" href="{{ url_for('static', filename='css/tablecomponent.css') }}">

{# 
  Enhanced Table Component with Search, Filter, and Sort functionality
  
  Features:
  - Global search across all columns
  - Column-specific filters with dropdown selectors
  - Sortable columns (click headers to sort ascending/descending)
  - Export to CSV functionality
  - Responsive design with modern gradient styling
  
  Usage:
  {{ table.render_table(
      data,                    # List of dictionaries with table data
      actions=True,            # Show action buttons column
      action_buttons=[...],    # Custom action buttons configuration
      identifier_key='id',     # Key to use for row identification
      url_patterns={...}       # URL patterns for action buttons
  ) }}
#}

{% macro render_table(data, filters={}, sort_key=None, sort_order='asc', actions=True, table_classes="table table-striped table-hover table-bordered", action_buttons=None, identifier_key='id', url_patterns=None) %}
  <div class="container mt-5 table-responsive">

    <!-- Table Controls -->
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-search"></i>üîç</span>
          <input type="text" class="form-control" placeholder="Search across all columns..." id="tableSearch" oninput="applySearch()">
        </div>
      </div>
      <div class="col-md-8 text-end">
        <button class="btn btn-outline-secondary" onclick="clearAllFilters()">Clear Filters</button>
        <button class="btn btn-outline-primary" onclick="exportTable()">Export CSV</button>
      </div>
    </div>

    <!-- Column Filters -->
    <div class="row mb-3">
      <div class="col-12">
        <div class="accordion" id="filterAccordion">
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFilters">
                <strong>Advanced Filters</strong> <span class="ms-2 badge bg-primary" id="filterCount">0</span>
              </button>
            </h2>
            <div id="collapseFilters" class="accordion-collapse collapse">
              <div class="accordion-body">
                <div id="columnFilters" class="row g-3"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% if data %}
      <table class="{{ table_classes }} custom-table-card" id="dataTable">
        <thead class="table-primary">
  <tr>
    {% for key in data[0].keys() %}
      <th class="text-center sortable" data-column="{{ key }}" onclick="sortTable('{{ key }}')" style="cursor: pointer;">
        <div class="d-flex align-items-center justify-content-center">
          <span>{{ key | title }}</span>
          <span class="sort-indicator ms-2">
            <span class="sort-arrow sort-asc">‚ñ≤</span>
            <span class="sort-arrow sort-desc">‚ñº</span>
          </span>
        </div>
      </th>
    {% endfor %}
    {% if actions %}
      <th class="text-center">Actions</th>
    {% endif %}
  </tr>
</thead>

        <tbody id="tableBody">
          {% for row in data %}
            <tr>
              {% for key, value in row.items() %}
                <td class="text-center">{{ value }}</td>
              {% endfor %}
              {% if actions %}
                <td class="text-center">
                  <div class="d-flex justify-content-center">
                    {% if action_buttons and url_patterns %}
                      {% for button in action_buttons %}
                        <a 
                          href="{{ url_for(url_patterns[button['endpoint']], **{identifier_key: row[identifier_key]}) }}" 
                          class="btn btn-clean btn-clean-{{ button['class'] }} me-2"
                          {% if button.get('title') %} title="{{ button['title'] }}" {% endif %}>
                          {{ button['label'] }}
                        </a>
                      {% endfor %}
                    {% else %}
                      <!-- Default action buttons if no action_buttons or url_patterns are provided -->
                      {% if url_patterns %}
                        <a href="{{ url_for(url_patterns['edit'], **{identifier_key: row[identifier_key]}) }}" 
                           class="btn btn-clean btn-clean-edit me-2" 
                           title="Edit this entry">
                           Edit
                        </a>
                        <a href="{{ url_for(url_patterns['delete'], **{identifier_key: row[identifier_key]}) }}" 
                           class="btn btn-clean btn-clean-delete me-2" 
                           title="Delete this entry">
                           Delete
                        </a>
                      {% else %}
                        <span class="text-muted">No actions available</span>
                      {% endif %}
                    {% endif %}
                  </div>
                </td>
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-center mt-4">No data available to display.</p>
    {% endif %}
  </div>

  <!-- JavaScript for Search, Filter, Sort and Export -->
  <script>
    let columnFilters = {};
    let currentSortColumn = null;
    let currentSortOrder = 'asc';

    // Initialize column filters on page load
    document.addEventListener('DOMContentLoaded', function() {
      initializeColumnFilters();
      updateFilterCount();
    });

    function initializeColumnFilters() {
      const table = document.getElementById('dataTable');
      if (!table) return;
      
      const headers = table.querySelectorAll('thead th');
      const filterContainer = document.getElementById('columnFilters');
      if (!filterContainer) return;
      
      filterContainer.innerHTML = '';
      
      headers.forEach((header, index) => {
        const columnName = header.dataset.column;
        if (!columnName) return;
        
        const uniqueValues = new Set();
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
          const cell = row.cells[index];
          if (cell) uniqueValues.add(cell.textContent.trim());
        });
        
        const filterDiv = document.createElement('div');
        filterDiv.className = 'col-md-3';
        filterDiv.innerHTML = `
          <label class="form-label">${header.textContent.trim()}</label>
          <select class="form-select form-select-sm" onchange="applyColumnFilter('${columnName}', ${index}, this.value)">
            <option value="">All</option>
            ${Array.from(uniqueValues).sort().map(val => 
              `<option value="${val}">${val}</option>`
            ).join('')}
          </select>
        `;
        filterContainer.appendChild(filterDiv);
      });
    }

    function applySearch() {
      const searchValue = document.getElementById('tableSearch').value.toLowerCase();
      const rows = document.querySelectorAll('#tableBody tr');
      
      rows.forEach(row => {
        let isMatch = false;
        let passesColumnFilters = true;
        
        // Check search match
        row.querySelectorAll('td').forEach(cell => {
          if (cell.textContent.toLowerCase().includes(searchValue)) {
            isMatch = true;
          }
        });
        
        // Check column filters
        for (let column in columnFilters) {
          const filterValue = columnFilters[column].value;
          const columnIndex = columnFilters[column].index;
          if (filterValue && row.cells[columnIndex]) {
            if (row.cells[columnIndex].textContent.trim() !== filterValue) {
              passesColumnFilters = false;
              break;
            }
          }
        }
        
        row.style.display = (isMatch || !searchValue) && passesColumnFilters ? '' : 'none';
      });
    }

    function applyColumnFilter(columnName, columnIndex, value) {
      if (value) {
        columnFilters[columnName] = { value: value, index: columnIndex };
      } else {
        delete columnFilters[columnName];
      }
      applySearch();
      updateFilterCount();
    }

    function updateFilterCount() {
      const count = Object.keys(columnFilters).length;
      const badge = document.getElementById('filterCount');
      if (badge) {
        badge.textContent = count;
        badge.className = count > 0 ? 'ms-2 badge bg-success' : 'ms-2 badge bg-primary';
      }
    }

    function clearAllFilters() {
      columnFilters = {};
      document.getElementById('tableSearch').value = '';
      document.querySelectorAll('#columnFilters select').forEach(select => {
        select.value = '';
      });
      applySearch();
      updateFilterCount();
    }

    function sortTable(columnName) {
      const table = document.getElementById('dataTable');
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const header = table.querySelector(`th[data-column="${columnName}"]`);
      const columnIndex = Array.from(header.parentElement.children).indexOf(header);
      
      // Update sort order
      if (currentSortColumn === columnName) {
        currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
      } else {
        currentSortColumn = columnName;
        currentSortOrder = 'asc';
      }
      
      // Remove all active sort indicators
      table.querySelectorAll('.sort-arrow').forEach(arrow => {
        arrow.style.opacity = '0.3';
      });
      
      // Highlight active sort indicator
      const sortIndicator = header.querySelector(`.sort-${currentSortOrder}`);
      if (sortIndicator) {
        sortIndicator.style.opacity = '1';
        sortIndicator.style.color = '#667eea';
      }
      
      // Sort rows
      rows.sort((a, b) => {
        const aValue = a.cells[columnIndex].textContent.trim();
        const bValue = b.cells[columnIndex].textContent.trim();
        
        // Try to parse as numbers
        const aNum = parseFloat(aValue);
        const bNum = parseFloat(bValue);
        
        if (!isNaN(aNum) && !isNaN(bNum)) {
          return currentSortOrder === 'asc' ? aNum - bNum : bNum - aNum;
        }
        
        // String comparison
        return currentSortOrder === 'asc' 
          ? aValue.localeCompare(bValue)
          : bValue.localeCompare(aValue);
      });
      
      // Reappend sorted rows
      rows.forEach(row => tbody.appendChild(row));
    }

    function exportTable() {
      const table = document.getElementById('dataTable');
      let csv = [];
      
      // Get headers
      const headers = [];
      table.querySelectorAll('thead th').forEach(th => {
        const text = th.textContent.trim();
        if (text && text !== 'Actions') headers.push(text);
      });
      csv.push(headers.join(','));
      
      // Get visible rows
      const rows = table.querySelectorAll('tbody tr');
      rows.forEach(row => {
        if (row.style.display !== 'none') {
          const rowData = [];
          row.querySelectorAll('td').forEach((td, index) => {
            if (index < headers.length) {
              rowData.push('"' + td.textContent.trim().replace(/"/g, '""') + '"');
            }
          });
          csv.push(rowData.join(','));
        }
      });
      
      // Download CSV
      const csvContent = csv.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', 'table_export_' + new Date().getTime() + '.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
{% endmacro %}
